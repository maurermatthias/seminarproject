package test2;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.List;

import org.hibernate.Query;
import org.hibernate.Session;
import org.hibernate.SessionFactory;

import entities.User;
import hibernate.HibernateUtil;

public class DBConnector {
	
	//admin-login-data
	static private String adminName = "admin";
	static private String adminPwd = "admin";
	static private String teacherName = "teacher";
	static private String teacherPwd = "teacher";

	//static private String dbName = "db1";
	private String userName = "java";
	private String password = "java1";
	private String dbUrl = "jdbc:mysql://localhost/db2";
	
	//singelton instance
	private static DBConnector instance;
	
	//private constructor
	private DBConnector() {
	}
	
	//get connection to DB
	public Connection getConnection(){

		Connection conn = null;
		try{
		    Class.forName("com.mysql.jdbc.Driver");
		    conn = DriverManager.getConnection(this.dbUrl,this.userName,this.password);
		}catch (SQLException | ClassNotFoundException ex) {
		    System.out.println("Not connected to database");
		} 
	    return conn;
	}
	
	//singelton getter
	public static DBConnector getInstance() {
		if (instance == null) {
			instance = new DBConnector();
			if(usernameFree(adminName)){
				try {
					addNewUser(adminName,adminPwd,3);
				} catch (ClassNotFoundException e) {
					System.out.println("Adding admin failed - 1");
					e.printStackTrace();
				} catch (SQLException e) {
					System.out.println("Adding admin failed - 2");
					e.printStackTrace();
				}
			}
			if(usernameFree(teacherName)){
				try {
					addNewUser(teacherName,teacherPwd,2);
				} catch (ClassNotFoundException e) {
					System.out.println("Adding teacher failed - 1");
					e.printStackTrace();
				} catch (SQLException e) {
					System.out.println("Adding teacher failed - 2");
					e.printStackTrace();
				}
			}
		}
		return instance;
	}

	///Methods for User-DB
	//check if username already exists
	public static boolean usernameFree(String name){
		
        SessionFactory sessionFactory = HibernateUtil.getSessionFactory();  
        Session session = sessionFactory.openSession(); 
        
        String hql = "from User where name = '"+name+"'";
        Query query = session.createQuery(hql);
        @SuppressWarnings("unchecked")
		List<User> listUser = query.list();
        
        if(listUser.size()==0){
        	return(true);
        }
		return false;
	}
	
	//add new user
	public static void addNewUser(String name,String pwd, Integer accessLevel) throws SQLException, ClassNotFoundException{
		if(usernameFree(name)){
			System.out.println("Adding new user");
			
	        SessionFactory sessionFactory = HibernateUtil.getSessionFactory();  
	        Session session = sessionFactory.openSession();  
	        session.beginTransaction();  
	          
	        User user = new User();  
	        user.setName(name);
	        user.setPwd(pwd);
	        user.setAccessLevel(accessLevel);
	          
	        session.save(user);  
	        session.getTransaction().commit();  
	          
	        session.close(); 
		}
		else{
			System.out.println("Adding new user not possible - username already exists!");
		}
		
	}
	
	
}
